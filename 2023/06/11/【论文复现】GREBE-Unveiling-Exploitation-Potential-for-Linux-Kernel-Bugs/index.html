<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>(论文复现)GREBE-Unveiling Exploitation Potential for Linux Kernel Bugs | Shaw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="VulnerabilityAEG" />
  
  
  
    <meta name="baidu-site-verification" content="63656ec0c686f8aaeeaad1b7243ba233" />
  
  
  <meta name="description" content="(论文复现)GREBE: Unveiling Exploitation Potential for Linux Kernel Bugs源码：Markakd&#x2F;GREBE (github.com)">
<meta property="og:type" content="article">
<meta property="og:title" content="(论文复现)GREBE-Unveiling Exploitation Potential for Linux Kernel Bugs">
<meta property="og:url" content="http://example.com/2023/06/11/%E3%80%90%E8%AE%BA%E6%96%87%E5%A4%8D%E7%8E%B0%E3%80%91GREBE-Unveiling-Exploitation-Potential-for-Linux-Kernel-Bugs/index.html">
<meta property="og:site_name" content="Shaw">
<meta property="og:description" content="(论文复现)GREBE: Unveiling Exploitation Potential for Linux Kernel Bugs源码：Markakd&#x2F;GREBE (github.com)">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230410171230.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230615150648.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230531152450.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230615150924.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230616155831.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230624193501.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230624192531.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230624193915.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230701154658.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702170621.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702170920.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702171220.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702171333.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702171718.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702172042.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702173055.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230615151312.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230413144329.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230413144452.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230413144554.png">
<meta property="og:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/image-20230607224055657.png">
<meta property="article:published_time" content="2023-06-11T07:19:53.000Z">
<meta property="article:modified_time" content="2023-09-04T07:12:46.000Z">
<meta property="article:author" content="Shaw">
<meta property="article:tag" content="Vulnerability">
<meta property="article:tag" content="AEG">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230410171230.png">
  
    <link rel="alternate" href="/atom.xml" title="Shaw" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/ytre.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/fashion.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" rel="home" >
                <img style="margin-bottom: 10px;"  width="124px" height="124px" alt="Hike News" src=" /css/images/ytre.jpg">
              </a>
            
          </h1>
          
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663" linktext="/"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663" linktext="archives"> <a class="" href="/archives">归档</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663" linktext="categories"> <a class="" href="/categories">分类</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663" linktext="tags"> <a class="" href="/tags">标签</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663" linktext="about"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-【论文复现】GREBE-Unveiling-Exploitation-Potential-for-Linux-Kernel-Bugs" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      (论文复现)GREBE-Unveiling Exploitation Potential for Linux Kernel Bugs
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2023/06/11/%E3%80%90%E8%AE%BA%E6%96%87%E5%A4%8D%E7%8E%B0%E3%80%91GREBE-Unveiling-Exploitation-Potential-for-Linux-Kernel-Bugs/" class="article-date">
	  <time datetime="2023-06-11T07:19:53.000Z" itemprop="datePublished">六月 11, 2023</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Paper/">Paper</a>
 
      
	<span id="busuanzi_container_page_pv">
	  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="论文复现-GREBE-Unveiling-Exploitation-Potential-for-Linux-Kernel-Bugs"><a href="#论文复现-GREBE-Unveiling-Exploitation-Potential-for-Linux-Kernel-Bugs" class="headerlink" title="(论文复现)GREBE: Unveiling Exploitation Potential for Linux Kernel Bugs"></a>(论文复现)GREBE: Unveiling Exploitation Potential for Linux Kernel Bugs</h1><p>源码：<a target="_blank" rel="noopener" href="https://github.com/Markakd/GREBE">Markakd/GREBE (github.com)</a></p>
<span id="more"></span>
<h1 id="1-Analysis"><a href="#1-Analysis" class="headerlink" title="1. Analysis"></a>1. Analysis</h1><h2 id="1-1-关键内核结构确定"><a href="#1-1-关键内核结构确定" class="headerlink" title="1.1 关键内核结构确定"></a>1.1 关键内核结构确定</h2><h3 id="1-1-1-report来源："><a href="#1-1-1-report来源：" class="headerlink" title="1.1.1 report来源："></a>1.1.1 <strong>report来源：</strong></h3><p>​    syzbot是一个基于syzkaller的自动化fuzzing系统。它能持续不停的运行syzkaller，对linux内核各个分支进行模糊测试，自动报告crash，监控bug的当前状态（是否已被修复等），监测对于bug的patch是否有效，完成发现-报告-复现-修复的整个流程。</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230410171230.png" alt="syzbot报告的错误列表" style="zoom:80%;" /></p>
<p>​    对每个错误，syzbot会发布其对应的报告以及可能存在的POC程序：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230615150648.png" alt="某个错误报告"></p>
<p>​    如上图所示，syzbot发布了某个错误发生时其对应的寄存器内容，call trace以及3次crashes（底部）的对应信息，可以看到，该错误提供了一个syz脚本编写的reproducer，也就是Poc程序。</p>
<p>​    syzkaller repro是用特殊的syzkaller符号编写的程序，它们可以在目标系统上执行。并且，syzkaller repro可以转化为对应的C语言poc，如果syzbot没有提供C语言的repro，它就无法使用C语言程序来触发该错误（这可能只是因为该错误是由一个竞态条件触发的）。</p>
<p>​    GREBE就是从这些报告中提取call trace进行后续分析。</p>
<h3 id="1-1-2-编译Analyzer"><a href="#1-1-2-编译Analyzer" class="headerlink" title="1.1.2 编译Analyzer"></a>1.1.2 编译Analyzer</h3><p>​    安装llvm–10（<a target="_blank" rel="noopener" href="https://apt.llvm.org/">LLVM Debian/Ubuntu packages</a>）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#To install a specific version of LLVM:</span>
<span class="token function">wget</span> https://apt.llvm.org/llvm.sh
<span class="token function">chmod</span> +x llvm.sh
<span class="token function">sudo</span> ./llvm.sh <span class="token operator">&lt;</span>version number<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>​    clang-10被安装在<code>/usr</code>中，故将analyer的make文件修改来指定clang，如下（这里直接指定C与C++编译器）：</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">CUR_DIR <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">shell</span> pwd<span class="token punctuation">)</span>
SRC_DIR <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">&#123;</span>CURDIR<span class="token punctuation">&#125;</span>/src
BUILD_DIR <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">&#123;</span>CURDIR<span class="token punctuation">&#125;</span>/build

<span class="token keyword">include</span> Makefile.inc

NPROC <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">&#123;</span>shell nproc<span class="token punctuation">&#125;</span>

build_ka_func <span class="token operator">=</span> \
	<span class="token punctuation">(</span>mkdir -p <span class="token variable">$</span><span class="token punctuation">&#123;</span>2<span class="token punctuation">&#125;</span> \
		&amp;&amp; cd <span class="token variable">$</span><span class="token punctuation">&#123;</span>2<span class="token punctuation">&#125;</span> \
        &amp;&amp;    cmake <span class="token variable">$</span><span class="token punctuation">&#123;</span>1<span class="token punctuation">&#125;</span> \
				-DCMAKE_CXX_COMPILER<span class="token operator">=</span>/home/wx/Shaw/llvm/patched_llvm/bin/clang++\
				-DCMAKE_C_COMPILER<span class="token operator">=</span>/home/wx/Shaw/llvm/patched_llvm/bin/clang\
                -DCMAKE_BUILD_TYPE<span class="token operator">=</span>Release \
                -DCMAKE_CXX_FLAGS_RELEASE<span class="token operator">=</span><span class="token string">"-std=c++14 -fno-rtti -fpic -g"</span> \
		&amp;&amp; make -j<span class="token variable">$</span><span class="token punctuation">&#123;</span>NPROC<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token symbol">all</span><span class="token punctuation">:</span> analyzer

<span class="token symbol">analyzer</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">call</span> build_ka_func, <span class="token variable">$</span><span class="token punctuation">&#123;</span>SRC_DIR<span class="token punctuation">&#125;</span>, <span class="token variable">$</span><span class="token punctuation">&#123;</span>BUILD_DIR<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​    接着修改analyzer/src中的CMakeLists.txt文件来指定LLVM：</p>
<pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">2.8.8</span><span class="token punctuation">)</span>
<span class="token keyword">project</span><span class="token punctuation">(</span>KANALYZER<span class="token punctuation">)</span>
<span class="token comment">#指定LLVM版本</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>LLVM_DIR <span class="token string">"/home/wx/Shaw/llvm/patched_llvm/lib/cmake/llvm"</span><span class="token punctuation">)</span>

<span class="token keyword">find_package</span><span class="token punctuation">(</span>LLVM REQUIRED CONFIG<span class="token punctuation">)</span>

<span class="token keyword">message</span><span class="token punctuation">(</span>STATUS <span class="token string">"Found LLVM <span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token variable">LLVM_PACKAGE_VERSION</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">message</span><span class="token punctuation">(</span>STATUS <span class="token string">"Using LLVMConfig.cmake in: <span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token variable">LLVM_DIR</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span>

<span class="token comment"># Set your project compile flags.</span>
<span class="token comment"># E.g. if using the C++ header files</span>
<span class="token comment"># you will need to enable C++14 support</span>
<span class="token comment"># for your compiler.</span>
<span class="token comment"># Check for C++14 support and set the compilation flag</span>
<span class="token keyword">include</span><span class="token punctuation">(</span>CheckCXXCompilerFlag<span class="token punctuation">)</span>
<span class="token comment">#CHECK_CXX_COMPILER_FLAG("-std=c++14" COMPILER_SUPPORTS_CXX14)</span>
<span class="token comment"># if(COMPILER_SUPPORTS_CXX14)</span>
<span class="token comment"># 	set(CMAKE_CXX_FLAGS "$&#123;CMAKE_CXX_FLAGS&#125; -std=c++14 -fno-rtti -fPIC -Wall")</span>
<span class="token comment"># else()</span>
<span class="token comment"># 	message(STATUS "The compiler $&#123;CMAKE_CXX_COMPILER&#125; has no C++14 support. Please use a different C++ compiler.")</span>
<span class="token comment"># endif()</span>

<span class="token keyword">include_directories</span><span class="token punctuation">(</span><span class="token punctuation">$&#123;</span>LLVM_INCLUDE_DIRS<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">add_definitions</span><span class="token punctuation">(</span><span class="token punctuation">$&#123;</span>LLVM_DEFINITIONS<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token keyword">add_subdirectory</span> <span class="token punctuation">(</span>lib<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​    编译好的analyer位于GREBE/analyzer/build/lib中。</p>
<h3 id="1-1-3-编译内核bitcode文件"><a href="#1-1-3-编译内核bitcode文件" class="headerlink" title="1.1.3 编译内核bitcode文件"></a>1.1.3 编译内核bitcode文件</h3><h4 id="1-1-3-1-安装带补丁的LLVM"><a href="#1-1-3-1-安装带补丁的LLVM" class="headerlink" title="1.1.3.1 安装带补丁的LLVM"></a>1.1.3.1 安装带补丁的LLVM</h4><p>​    内核bitcode文件指的是待测试的Linux内核，需要将其编译为bc文件后进行分析。</p>
<p>​    这里需要使用llvm-10并且给LLVM编译器打上补丁，以便在调用任何编译器优化通道之前转储比特码。通过这种方式，可以防止编译器优化影响分析的准确性。<u>故这里单独准备一个llvm并安装到特定文件夹中，以避免对全局llvm的影响：</u></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">git</span> clone https://github.com/llvm/llvm-project
<span class="token builtin class-name">cd</span> llvm-project
<span class="token function">git</span> checkout 5521236a18074584542b81fd680158d89a845fca<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>​    打补丁：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">patch -p0 <span class="token operator">&lt;</span> WriteBitcode.patch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230531152450.png" style="zoom: 50%;" /></p>
<p>​    build clang:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">mkdir</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build
cmake -DCMAKE_INSTALL_PREFIX<span class="token operator">=</span>/home/wx/Shaw/llvm/patched_llvm -DLLVM_ENABLE_PROJECTS<span class="token operator">=</span>clang -DCMAKE_BUILD_TYPE<span class="token operator">=</span>Release  -G <span class="token string">"Unix Makefiles"</span> <span class="token punctuation">..</span>/llvm
<span class="token function">sudo</span> <span class="token function">make</span> -j<span class="token variable"><span class="token variable">$(</span>nproc<span class="token variable">)</span></span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>​    这里通过指定<code>DCMAKE_INSTALL_PREFIX</code>的方式指定其安装位置。注意，LLVM编译后体积非常大，如果在虚拟机中编译需要给足够内存和硬盘空间（80G+）。</p>
<h4 id="1-1-3-2-编译内核"><a href="#1-1-3-2-编译内核" class="headerlink" title="1.1.3.2 编译内核"></a>1.1.3.2 编译内核</h4><p>​    编译安装完带有特定补丁的LLVM，接下来就需要使用其来编译Linux内核源码。</p>
<p>​    以<a target="_blank" rel="noopener" href="https://syzkaller.appspot.com/bug?extid=4b52080e97cde107939d">KASAN: slab-use-after-free Read in hfsplus_read_wrapper</a>为例，其附带的.config文件中详细的说明了漏洞的内核版本、config编译选项等信息。</p>
<p>​    在<a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/refs/tags">kernel/git/torvalds/linux.git - Linux kernel source tree</a>处下载对应版本的内核源码，解压后先安装编译所需的包：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">git</span> fakeroot build-essential ncurses-dev xz-utils libssl-dev <span class="token function">bc</span> flex libelf-dev bison<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>​    使用如下命令编译,<code>CC</code>和<code>CXX</code>指定为带补丁的clang，由于LLVM-10存在一定bug，这里令<code>LLVM_IAS</code>为0关闭<strong>integrated assembler</strong>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> <span class="token assign-left variable">CC</span><span class="token operator">=</span>/home/wx/Shaw/llvm/patched_llvm/bin/clang <span class="token assign-left variable">CXX</span><span class="token operator">=</span>/home/wx/Shaw/llvm/patched_llvm/bin/clang++ <span class="token assign-left variable">LLVM_IAS</span><span class="token operator">=</span><span class="token number">0</span> all -j<span class="token variable"><span class="token variable">$(</span>nproc<span class="token variable">)</span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>​    analyzer编译完成后，使用如下命令运行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python run_analyze.py ./case<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>​    可以在对应case目录下看到对应的解析结果<code>sys.txt</code>：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230615150924.png" style="zoom: 50%;" /></p>
<p>​    注意：</p>
<blockquote>
<ol>
<li><p><strong>编译analyzer与源码的LLVM一定要相同版本；</strong></p>
</li>
<li><p><strong>作者给出的LLVM-10是可以成功运行的，但是存在的问题如下：</strong></p>
<p>  a. 目前使用LLVM编译新版本的内核最低要求其版本为11，其无法编译内核；</p>
<p>  b. 如果使用LLVM-11，其编译analyzer存在错误（见文末错误日志）；</p>
<p>  <u>故目前作者仓库中给出的代码仅适合版本不高的内核。</u></p>
</li>
<li><p><strong>部分工作已通过脚本自动化，整个内核的下载+解压+编译已自动化为<code>/analyzer/scripts/get_kernel.py</code>，复现analyzer需要：</strong></p>
<p>  a. 在/analyzer/Testcase/下创建对应case文件夹，命名格式为case+数字；</p>
<p>  b. 将对应report中的.config文件与report文件以名称<code>.config</code>和<code>report</code>复制到case文件夹中；</p>
<p>  c. 修改/analyzer/scripts/下的三个py文件中的<code>CASE_DIR</code>，<code>PATCHED_LLVM</code>和<code>AnalyzerPath</code>变量，使其分别对应Testcase，打过补丁的LLVM和编译好的analyzer；</p>
<p>  d. 按次序运行<code>get_cg.py</code>、<code>get_kernel.py</code>和<code>run_analyze.py</code>，其参数为case序号，例如：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#分析/analyzer/Testcases/case7</span>
python get_cg.py <span class="token number">7</span>
python get_kernel.py <span class="token number">7</span>
python run_analyze.py <span class="token number">7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
</blockquote>
<h3 id="1-1-3-静态分析代码解析"><a href="#1-1-3-静态分析代码解析" class="headerlink" title="1.1.3  静态分析代码解析"></a>1.1.3  静态分析代码解析</h3><p>​    见<a target="_blank" rel="noopener" href="https://shawdox.github.io/2023/05/09/[代码分析]GREBE-Analyzer污点分析代码解析/">(代码分析)GREBE-Analyzer污点分析代码解析 | Shaw (shawdox.github.io)</a></p>
<h1 id="2-Fuzzing"><a href="#2-Fuzzing" class="headerlink" title="2. Fuzzing"></a>2. Fuzzing</h1><h2 id="2-1-编译GCC"><a href="#2-1-编译GCC" class="headerlink" title="2.1 编译GCC"></a>2.1 编译GCC</h2><p>​    使用作者提供的gcc-9.3.0来编译内核，首先进入其文件夹中编译GCC：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./contrib/download_prerequisites
<span class="token function">mkdir</span> gcc-bin
<span class="token builtin class-name">export</span> <span class="token assign-left variable">INSTALLDIR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/gcc-bin
<span class="token function">mkdir</span> gcc-build
<span class="token builtin class-name">cd</span> gcc-build
<span class="token punctuation">..</span>/configure --prefix<span class="token operator">=</span><span class="token variable">$INSTALLDIR</span> --enable-languages<span class="token operator">=</span>c,c++
<span class="token function">make</span> -j<span class="token variable"><span class="token variable">`</span>nproc<span class="token variable">`</span></span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​    </p>
<h2 id="2-2-使用GCC编译内核"><a href="#2-2-使用GCC编译内核" class="headerlink" title="2.2 使用GCC编译内核"></a>2.2 使用GCC编译内核</h2><p>​    在内核代码中运行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">OBJ_FILE</span><span class="token operator">=</span><span class="token string">"/home/wx/Shaw/GREBE/analyzer/TestCases/case7/sts.txt"</span>
<span class="token function">make</span> <span class="token assign-left variable">CC</span><span class="token operator">=</span><span class="token string">"/home/wx/Shaw/GREBE/gcc-9.3.0/gcc-bin/bin/gcc"</span> -j<span class="token variable"><span class="token variable">`</span>nproc<span class="token variable">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>​    注意，内核的.config文件标志了其编译所需的最低版本，故不论是用clang编译还是gcc都需要符合对应版本。</p>
<h2 id="2-3-编译Fuzzer"><a href="#2-3-编译Fuzzer" class="headerlink" title="2.3 编译Fuzzer"></a>2.3 编译Fuzzer</h2><p>​    GREBE的Fuzzer是syzkaller的改版，其使用方法与syzkaller基本相同。根据syzkaller官方给出的方法编译，这里集成为/fuzzer/compile_fuzzer.py：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#Author: xiao wu</span>
<span class="token comment">#Time: 2023.6.16</span>
<span class="token comment">#Functionality:</span>
<span class="token comment">#   Complie the modified syzkaller</span>

<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">assert</span> <span class="token punctuation">(</span><span class="token string">'linux'</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>platform<span class="token punctuation">)</span>

GO_DIR <span class="token operator">=</span> <span class="token string">"/home/wx/Shaw/go"</span>
FUZZ_DIR <span class="token operator">=</span> <span class="token string">"/home/wx/Shaw/GREBE/fuzzer"</span>

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"PATH"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> GO_DIR<span class="token operator">+</span><span class="token string">"/bin"</span>
os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>FUZZ_DIR<span class="token punctuation">)</span>
os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"make"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​    这里需要在脚本中指定Go语言环境以及fuzzer的位置，Go的版本需要大于等于1.11。编译好的fuzzer位于/fuzzer/bin中。</p>
<h2 id="2-4-测试QEMU"><a href="#2-4-测试QEMU" class="headerlink" title="2.4 测试QEMU"></a>2.4 测试QEMU</h2><p>​    syz-manager需要通过ssh来与ssh-fuzzer通信，后者运行在QEMU中，故在运行syzkaller之前，需要手动测试QEMU连通性：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">qemu-system-x86_64 <span class="token punctuation">\</span>
  -m 2G <span class="token punctuation">\</span>
  -smp <span class="token number">2</span> <span class="token punctuation">\</span>
  -kernel <span class="token variable">$KERNEL</span>/arch/x86/boot/bzImage <span class="token punctuation">\</span>
  -append <span class="token string">"console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0"</span> <span class="token punctuation">\</span>
  -drive <span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token variable">$IMAGE</span>/bullseye.img,format<span class="token operator">=</span>raw <span class="token punctuation">\</span>
  -net user,host<span class="token operator">=</span><span class="token number">10.0</span>.2.10,hostfwd<span class="token operator">=</span>tcp:127.0.0.1:10021-:22 <span class="token punctuation">\</span>
  -net nic,model<span class="token operator">=</span>e1000 <span class="token punctuation">\</span>
  -enable-kvm <span class="token punctuation">\</span>
  -nographic <span class="token punctuation">\</span>
  -pidfile vm.pid <span class="token punctuation">\</span>
  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> vm.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​    注意，QEMU需要当前系统支持KVM虚拟化，如果是虚拟机可以直接查找对应处理器设置，如果是物理机需要在BIOS中开启。</p>
<p>​    成功开启QEMU后另开一个bash，用ssh测试其连通性：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> -i <span class="token variable">$IMAGE</span>/bullseye.id_rsa -p <span class="token number">10021</span> -o <span class="token string">"StrictHostKeyChecking no"</span> root@localhost<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>​    如果成果连通则说明QEMU通信部分没有问题，具体配置过程以及相关可能的问题可见：<a target="_blank" rel="noopener" href="https://shawdox.github.io/2023/06/11/[技术积累]Syzkaller环境配置/">(技术积累)Syzkaller环境配置 | Shaw (shawdox.github.io)</a></p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230616155831.png" alt=""></p>
<p>​    </p>
<h2 id="2-5-运行fuzzer"><a href="#2-5-运行fuzzer" class="headerlink" title="2.5 运行fuzzer"></a>2.5 运行fuzzer</h2><p>​    直接使用/fuzzer/scripts/run_fuzzer.py脚本即可运行fuzzer，其会自动定位case文件夹并创建对应的config文件，运行syz-manager:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python run_fuzzer.py <span class="token punctuation">[</span>case_number<span class="token punctuation">]</span>
<span class="token comment">#python run_fuzzer.py 8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>​    下面是run_fuzzer.py的运行逻辑：</p>
<ol>
<li><p>首先在对应的case文件夹下创建其config文件：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230624193501.png" style="zoom:50%;" /></p>
<ol>
<li>然后将config文件复制到workdir（如上图）中：</li>
</ol>
</li>
</ol>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230624192531.png" style="zoom: 67%;" /></p>
<p>​    如上图fuzzer源码所示，注意到poc是默认位于workdir中的，<strong><u>故在使用命令时仅传入poc文件名称即可</u></strong>（此次复现中，poc.txt默认位于对应的case文件夹中，这里run_fuzzer.py脚本会在运行syz-manager前将对应的poc.txt复制过来）。</p>
<pre><code>3. 运行syz-manager:
</code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">syz-manager -config /home/wx/Shaw/GREBE/analyzer/TestCases/case8/syzconfig.cfg --auxiliary poc.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>​    再次注意，由于fuzzer源码限制，使用<code>--auxiliary</code>标志传入poc.txt只能传入该名称，并且poc.txt文件应该位于workdir文件夹下。</p>
<p>​    运行即可得到对应结果：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230624193915.png" alt=""></p>
<h2 id="2-6-原理解析"><a href="#2-6-原理解析" class="headerlink" title="2.6 原理解析"></a>2.6 原理解析</h2><blockquote>
<p>​    对gcc和kernel都做了修改，使其在编译内核时可以将特定的basic block的16bit地址替换为一个magic_number，这样在代码覆盖率反馈中就可以识别哪些basic block属于关键内核对象。</p>
</blockquote>
<h3 id="2-6-1-Syzkaller原理"><a href="#2-6-1-Syzkaller原理" class="headerlink" title="2.6.1 Syzkaller原理"></a>2.6.1 Syzkaller原理</h3><p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230701154658.png" alt=""></p>
<p>​    如上图所示，具体描述见：<a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/internals.md">syzkaller/docs/internals.md at master · google/syzkaller · GitHub</a></p>
<h3 id="2-6-2-Syscall-descriptions"><a href="#2-6-2-Syscall-descriptions" class="headerlink" title="2.6.2 Syscall descriptions"></a>2.6.2 Syscall descriptions</h3><p>​    Syzkaller使用声明性的系统调用描述来控制程序（系统调用的序列），举例：</p>
<pre class="line-numbers language-none"><code class="language-none">open(file filename, flags flags[open_flags], mode flags[open_mode]) fd
read(fd fd, buf buffer[out], count len[buf])
close(fd fd)
open_mode &#x3D; S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>​    翻译后的系统调用描述被用来生成、变异、执行、最小化、序列化和反序列化程序，程序指的是有着一系列具体参数的系统调用，例如：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">r0 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">0x7f0000000000</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">"./file0"</span><span class="token punctuation">,</span> <span class="token number">0x3</span><span class="token punctuation">,</span> <span class="token number">0x9</span><span class="token punctuation">)</span>
<span class="token function">read</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">0x7f0000000000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span>
<span class="token function">close</span><span class="token punctuation">(</span>r0<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>​    在实际操作中，syzkaller使用类似AST的内存表示法，由prog/prog.go中定义的Call和Arg值组成。这种表示法被用来分析、生成、变异、最小化、验证等程序。内存中的表示法可以转换为文本形式，以存储在磁盘语料库中，并展示给人类，等等。还有另一种程序的二进制表示法（称为exec），它更简单，不包含丰富的类型信息（不可逆），用于实际执行（解释）程序。</p>
<h3 id="2-6-3-Coverage"><a href="#2-6-3-Coverage" class="headerlink" title="2.6.3 Coverage"></a>2.6.3 Coverage</h3><h4 id="2-6-3-1-Syzkaller-Coverage"><a href="#2-6-3-1-Syzkaller-Coverage" class="headerlink" title="2.6.3.1 Syzkaller Coverage"></a>2.6.3.1 Syzkaller Coverage</h4><p>​    覆盖率通过追踪<code>coverage points</code>的方式获取，<code>coverage points</code><u>一般通过编译器插入对象代码中。</u><code>coverage points</code>一般指一个基本块或者CFG边（取决于编译器，例如clang默认是cfg边而gcc是基本块），<u>编译器在翻译转换和优化代码的过程中插入<code>coverage points</code></u>。</p>
<p>​    因此，覆盖率与源代码的关系可能很差。例如，你可能会在一个非覆盖行之后看到一个覆盖行，或者你可能在你期望看到的地方没有看到覆盖点，反之亦然（如果编译器拆分基本块，或将控制流结构变成没有控制流的条件动作，就可能发生这种情况。）。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/coverage.md#syz-cover这里可以参照官网的syz-cover来从原始覆盖数据中生成报告。">https://github.com/google/syzkaller/blob/master/docs/coverage.md#syz-cover这里可以参照官网的syz-cover来从原始覆盖数据中生成报告。</a></p>
</blockquote>
<p>​    Syzkaller使用<code>kcov</code>来从Linux内核中获取代码覆盖率，<code>kcov</code>会输出每个被运行的基本块的地址，然后syzkaller会用objdump、nm、addr2line、readelf等<code>binutils</code>工具来将该地址映射到源码对应的行数。</p>
<h4 id="2-6-3-2-GREBE-Coverage"><a href="#2-6-3-2-GREBE-Coverage" class="headerlink" title="2.6.3.2 GREBE Coverage"></a>2.6.3.2 GREBE Coverage</h4><ul>
<li><strong>GREBE-GCC</strong></li>
</ul>
<p>​    <a target="_blank" rel="noopener" href="https://github.com/whoismissing/grebe-gcc/commit/172f8e6694c41c5c4cf532d86dc4edaaafaad6ed?diff=split">add grebe code changes · whoismissing/grebe-gcc@172f8e6 (github.com)</a>这里可以看到GREBE对GCC9.3.0版本做了怎样的修改，其修改了两个文件：<code>sancov.c</code>和<code>sanitizer.def</code>。</p>
<p>​    首先，GREBE在sancov.c中定义了存储关键对象的结构struct_maps:</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702170621.png" style="zoom:67%;" /></p>
<p>​    定义了init_structs()函数，用于将从analyzer生成的内核关键对象读取到st_map-&gt;st数组中：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702170920.png" style="zoom:67%;" /></p>
<p>​    定义了process_tree()函数，用于匹配关键内核对象：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702171220.png" style="zoom:67%;" /></p>
<p>​    定义了find_st()函数，用于从tree中找出符合关键内核对象的子树：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702171333.png" style="zoom:67%;" /></p>
<p>​    然后在sancov_pass()函数中插入以下代码：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702171718.png" style="zoom:67%;" /></p>
<p>​    这段代码的大致作用是选择对basic block做插桩的函数，<code>BUILT_IN_SANITIZER_COV_TRACE_PC</code>是kcov原本的插桩函数，<code>BUILT_IN_SANITIZER_OBJ_COV_TRACE_PC</code>是GREBE实现的插桩函数，二者都在对应内核的kernel/kcov.c文件中实现，二者的区别如下：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702172042.png" alt=""></p>
<p>​    其中，<code>_RET_IP_</code>代表当前函数的返回地址，可以发现，GREBE实现的<code>BUILT_IN_SANITIZER_OBJ_COV_TRACE_PC</code>相较于<code>BUILT_IN_SANITIZER_COV_TRACE_PC</code>就是将返回地址截取了前32位。</p>
<p>​    回到sancov_pass()，其遍历每个基本块，对于非空基本块判断其是否是关键内核对象，如果是则将<code>fndecl</code>设置为<code>BUILT_IN_SANITIZER_OBJ_COV_TRACE_PC</code>，否则设置为<code>BUILT_IN_SANITIZER_COV_TRACE_PC</code>。然后代码根据<code>fndecl</code>设置一个gcall，将其插入到代码块之前。</p>
<p>​    最后，在sanitizer.def文件中，将自己实现的__sanitizer_obj_cov_trace_pc()定义为sanitizer函数:</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230702173055.png" style="zoom:67%;" /></p>
<ul>
<li><strong>GREBE-Syzkaller</strong></li>
</ul>
<h1 id="3-错误日志"><a href="#3-错误日志" class="headerlink" title="3. 错误日志"></a>3. 错误日志</h1><ul>
<li><p><strong>问题1：编译llvm时报错：</strong></p>
<blockquote>
<p>Killed (program cc1plus)<br>Please submit a full bug report,<br>with preprocessed source if appropriate.<br>See <a href="file:///usr/share/doc/gcc-5/README.Bugs">file:///usr/share/doc/gcc-5/README.Bugs</a> for instructions.<br>lib/DebugInfo/CodeView/CMakeFiles/LLVMDebugInfoCodeView.dir/build.make:494: recipe for target ‘lib/DebugInfo/CodeView/CMakeFiles/LLVMDebugInfoCodeView.dir/EnumTables.cpp.o’ failed<br>make[2]: <strong><em> [lib/DebugInfo/CodeView/CMakeFiles/LLVMDebugInfoCodeView.dir/EnumTables.cpp.o] Error 4<br>CMakeFiles/Makefile2:6769: recipe for target ‘lib/DebugInfo/CodeView/CMakeFiles/LLVMDebugInfoCodeView.dir/all’ failed<br>make[1]: </em></strong> [lib/DebugInfo/CodeView/CMakeFiles/LLVMDebugInfoCodeView.dir/all] Error 2</p>
</blockquote>
</li>
</ul>
<p><strong>解决方法：</strong></p>
<p>编译时虚拟机的内存与硬盘空间太小，在服务器上跑即可成功编译。</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230615151312.png" alt=""></p>
<ul>
<li><p><strong>问题2：在编译analyzer时报错：</strong></p>
<blockquote>
<p>error: no member named ‘hasNPredecessorsOrMore’ in ‘llvm::BasicBlock’</p>
</blockquote>
</li>
<li><p><strong>解决方法：</strong></p>
<p>查看错误报告发现是LLVM的BasicBlock没找到对应的子数据结构<code>hasNPredecessorsOrMore</code>，首先在LLVM官网查找对应数据结构定义：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230413144329.png" style="zoom: 25%;" /></p>
<p>​    可以看到在<code>BasicBlock.cpp</code>的319行有该数据结构的定义，查找本机上下载的llvm源码：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230413144452.png" style="zoom: 50%;" /></p>
<p>​    查找对应源码是可以发现对应数据结构定义的：</p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/20230413144554.png" style="zoom:50%;" /></p>
<p>​    阅读报错信息，发现编译时自动搜索到了以前安装的llvm-6.0旧版本，手动更改路径，上述问题解决，但是发现仍旧报错。</p>
<p>​    在llvm的github项目中找到了一样错误：<a target="_blank" rel="noopener" href="https://github.com/google/autofdo/issues/87">Build failure when targeting LLVM 11.0 · Issue #87 · google/autofdo (github.com)</a>。<strong><u>可以基本确定这是LLVM-11的问题，换回LLVM-10版本即可解决</u></strong>。</p>
</li>
<li><p><strong>问题3：在编译analyzer时报错：</strong></p>
<blockquote>
<p>ld: cannot find -lz</p>
</blockquote>
<p><strong>解决方法：</strong></p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> zlib1g zlib1g-dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><p><strong>问题4：在使用analyer时报错：</strong></p>
<blockquote>
<p>/home/wx/Shaw/GREBE/analyzer/build/lib/analyzer: error loading file ‘./case/linux-bitcode/lib/dump_stack.c.bc’</p>
</blockquote>
<p><strong>解决方法：</strong></p>
<p>问题定位到KAMain.cc文件使用ParseIR()函数解析bc文件：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Module<span class="token operator">></span> M <span class="token operator">=</span> <span class="token function">parseIRFile</span><span class="token punctuation">(</span>InputFilenames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> Err<span class="token punctuation">,</span> <span class="token operator">*</span>LLVMCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>M <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": error loading file '"</span> <span class="token operator">&lt;&lt;</span> InputFilenames<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"'\n"</span><span class="token punctuation">;</span>
     <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><strong>问题5：编译内核（部分版本）时报错：</strong></p>
<blockquote>
<p>error New address family defined, please update secclass_map.</p>
</blockquote>
<p><strong>解决方法：</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangpengfei991023/article/details/109672491">编译错误 error New address family defined, please update secclass_map.解决-CSDN博客</a></p>
</li>
<li><p><strong>问题6：编译内核（部分版本）时报错：</strong></p>
<blockquote>
<p><strong>passing argument 1 to restrict-qualified parameter aliases with argument 5 [-Werror=restrict]</strong></p>
<p>cc1: all warnings being treated as errors</p>
</blockquote>
<p><strong>解决方法：</strong></p>
<p>对<code>tools/lib/str_error_r.c</code>打如下补丁：</p>
<p><a target="_blank" rel="noopener" href="https://lore.kernel.org/all/b5d9ea0f-3a3e-ec87-df76-10be4bd72b90@redhat.com/">Re: New -Werror=restrict error with incremental gcc - Laura Abbott (kernel.org)</a></p>
<p><img src="https://shaw-typora.oss-cn-beijing.aliyuncs.com/image-20230607224055657.png" alt=""></p>
</li>
<li><p><strong>问题7：无法使用py脚本（在其中使用export）改变环境变量</strong></p>
<p><strong>解决方法：</strong></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1506010/how-to-use-export-with-python-on-linux">How to use export with Python on Linux - Stack Overflow</a></p>
</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li>GREBE:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Markakd/GREBE/tree/master/analyzer">GREBE/analyzer at master · Markakd/GREBE (github.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Markakd/LLVM-O0-BitcodeWriter/tree/master">Markakd/LLVM-O0-BitcodeWriter: patch for LLVM to generate O0 bitcode (github.com)</a></li>
</ul>
</li>
<li>LLVM:<ul>
<li><a target="_blank" rel="noopener" href="https://apt.llvm.org/">LLVM Debian/Ubuntu packages</a></li>
</ul>
</li>
<li>Kernel:<ul>
<li><a target="_blank" rel="noopener" href="https://phoenixnap.com/kb/build-linux-kernel">How To Build Linux Kernel {Step-By-Step} | phoenixNAP KB</a></li>
<li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/external/syzkaller/+/HEAD/docs/linux/setup_ubuntu-host_qemu-vm_x86-64-kernel.md">Setup: Ubuntu host, QEMU vm, x86-64 kernel (googlesource.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/dev-tools/kcov.html">KCOV: code coverage for fuzzing — The Linux Kernel documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/translations/zh_CN/dev-tools/testing-overview.html#id3">内核测试指南 — The Linux Kernel documentation</a></li>
</ul>
</li>
<li>Syzkaller：<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/internals.md">syzkaller/docs/internals.md at master · google/syzkaller · GitHub</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/setup_ubuntu-host_qemu-vm_x86-64-kernel.md">syzkaller/docs/linux/setup_ubuntu-host_qemu-vm_x86-64-kernel.md at master · google/syzkaller · GitHub</a></li>
<li><a target="_blank" rel="noopener" href="https://shawdox.github.io/2023/06/11/[技术积累]Syzkaller环境配置/">(技术积累)Syzkaller环境配置 | Shaw (shawdox.github.io)</a></li>
<li><a target="_blank" rel="noopener" href="https://davejingtian.org/2017/06/01/understanding-kcov-play-with-fsanitize-coveragetrace-pc-from-the-user-space/#:~:text=kcov is a kernel feature used to support,patched to enable this feature where is propriate.">Understanding kcov – play with -fsanitize-coverage=trace-pc from the user space | davejingtian.org</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_38816924/article/details/122048886">kcov-用于内核模糊测试的代码覆盖-CSDN博客</a></li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Paper/">Paper</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AEG/" rel="tag">AEG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vulnerability/" rel="tag">Vulnerability</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/06/11/%E3%80%90%E6%8A%80%E6%9C%AF%E7%A7%AF%E7%B4%AF%E3%80%91Syzkaller%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          (技术积累)Syzkaller环境配置
        
      </div>
    </a>
  
  
    <a href="/2023/05/30/%E3%80%90%E6%8A%80%E6%9C%AF%E7%A7%AF%E7%B4%AF%E3%80%91Klee%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">(技术积累)Klee安装使用</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BA%E6%96%87%E5%A4%8D%E7%8E%B0-GREBE-Unveiling-Exploitation-Potential-for-Linux-Kernel-Bugs"><span class="nav-number">1.</span> <span class="nav-text">(论文复现)GREBE: Unveiling Exploitation Potential for Linux Kernel Bugs</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Analysis"><span class="nav-number">2.</span> <span class="nav-text">1. Analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%85%B3%E9%94%AE%E5%86%85%E6%A0%B8%E7%BB%93%E6%9E%84%E7%A1%AE%E5%AE%9A"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 关键内核结构确定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-report%E6%9D%A5%E6%BA%90%EF%BC%9A"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1.1 report来源：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2-%E7%BC%96%E8%AF%91Analyzer"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.1.2 编译Analyzer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-3-%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8bitcode%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.3.</span> <span class="nav-text">1.1.3 编译内核bitcode文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-3-1-%E5%AE%89%E8%A3%85%E5%B8%A6%E8%A1%A5%E4%B8%81%E7%9A%84LLVM"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">1.1.3.1 安装带补丁的LLVM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-3-2-%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">1.1.3.2 编译内核</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-3-%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">2.1.4.</span> <span class="nav-text">1.1.3  静态分析代码解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Fuzzing"><span class="nav-number">3.</span> <span class="nav-text">2. Fuzzing</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E7%BC%96%E8%AF%91GCC"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 编译GCC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E4%BD%BF%E7%94%A8GCC%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 使用GCC编译内核</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E7%BC%96%E8%AF%91Fuzzer"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 编译Fuzzer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E6%B5%8B%E8%AF%95QEMU"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 测试QEMU</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E8%BF%90%E8%A1%8Cfuzzer"><span class="nav-number">3.5.</span> <span class="nav-text">2.5 运行fuzzer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="nav-number">3.6.</span> <span class="nav-text">2.6 原理解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-1-Syzkaller%E5%8E%9F%E7%90%86"><span class="nav-number">3.6.1.</span> <span class="nav-text">2.6.1 Syzkaller原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-2-Syscall-descriptions"><span class="nav-number">3.6.2.</span> <span class="nav-text">2.6.2 Syscall descriptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-3-Coverage"><span class="nav-number">3.6.3.</span> <span class="nav-text">2.6.3 Coverage</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-3-1-Syzkaller-Coverage"><span class="nav-number">3.6.3.1.</span> <span class="nav-text">2.6.3.1 Syzkaller Coverage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-3-2-GREBE-Coverage"><span class="nav-number">3.6.3.2.</span> <span class="nav-text">2.6.3.2 GREBE Coverage</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="nav-number">4.</span> <span class="nav-text">3. 错误日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">4.1.</span> <span class="nav-text">Reference</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    
<footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2025 Shaw All Rights Reserved.
        
          <span id="busuanzi_container_site_pv">
            本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
            本站访客数<span id="busuanzi_value_site_uv"></span>人
          </span>
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>

  
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/bootstrap.js"></script>


<script src="/js/main.js"></script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'true', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<!-- Gaug.es Analytics -->
<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', 'true');
    t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
    t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
<!-- End Gaug.es Analytics -->




  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>



	<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2439014eb270056ee1808a49956fe114";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>




<!-- Tencent Analytics -->
	<script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId={{ theme.tencent_analytics }}";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
<!-- End Tencent Analytics -->


  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
